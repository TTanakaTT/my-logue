このリポジトリは SvelteKit (Vite + Svelte 5 + TypeScript) による選択式ローグライトゲームです。開発において以下の方針/約束を守ってください。

## 開発フロー

| シナリオ             | コマンド       | 内容                                          |
| -------------------- | -------------- | --------------------------------------------- |
| 依存取得             | `pnpm install` | 依存ライブラリ取得                            |
| 開発サーバ           | `pnpm dev`     | Vite 開発サーバ (Playwright E2E もこれに依存) |
| 型+Svelte チェック   | `pnpm check`   | `svelte-check` による型/コンポーネント検証    |
| Lint & Prettier 検証 | `pnpm lint`    | Prettier 差分 + ESLint                        |
| 自動整形             | `pnpm format`  | Prettier で一括整形                           |

### Commit / PR 前のチェック (必須)

1. `pnpm format` を実行し整形差分を確定
2. `pnpm lint` で ESLint / Prettier チェックが全てパス
3. `pnpm check` で型エラーが無いこと
4. 大きなゲームバランス変更時は `README.md` か、別途 `docs/` (未作成なら提案) への反映を検討

CIの想定シーケンス例: format → lint → type check。

### データ変更

CSV (`characters.csv`, `rewards.csv` 等) を変更する場合は:

1. 破壊的変更 (列追加/削除) 時に読み込み側 Repository (`src/lib/data/repositories/*Repository.ts`) を同期更新

## コードスタイル / 設計指針

1. 同等/ほぼ同等なコードが現れたら抽出し、共通化、コンポーネント化することを検討する。重複ロジック、二重定義は早期に共通化する。
2. 整理されたコードを優先して、既存コードの踏襲は最小限にし、破壊的な変更も実施する。
3. 不要になったコード/型/データ (未使用の関数・変数・コンポーネント・CSV 列等) は速やかに削除しコメントアウト放置を避ける。
4. 1ファイルの責務はなるべく小さくし、コードの拡張により肥大化した場合は分割を検討する。

### CSS / スタイルルール

- レイアウト・スペーシングなどのマジックナンバーは極力避け、共通トークン化（ユーティリティ化/変数化）を検討する。

### コメント / ドキュメント

- 複雑な計算 (ダメージ、成長ロジック等) は数式や確率根拠を JSDoc で簡潔に記述。
- 意図を失いやすいマジックナンバーは禁止。`const` 命名で意味付け。
- コメントは全て英語で記述。日本語禁止。

### 表示文言 / i18n (Paraglide) ルール

- 画面に表示されるテキストは、必ず Paraglide 経由で提供すること。
  - 直接の文字列リテラル（ハードコード）は禁止。
- 反映手順:
  1.  `messages/ja.json` / `messages/en.json` にキーを追加・更新
  2.  `pnpm build` を実行して Paraglide の生成物を更新
  3.  コード側では `import { m } from '$lib/paraglide/messages'` を用い `m.key()` を呼び出して表示
- コンポーネント/サービス内で複数箇所に跨る文言は、必要に応じてキーを整理し、重複定義を避けること。
- 既存のハードコード文言を見つけた場合は、同PRで Paraglide への移行を行うこと。

## LLM 生成コードのガードレール

構造の崩壊や設計逸脱を防ぐため、LLM による生成・修正時は以下を厳守してください。

### 層と責務の境界

- domain（`src/lib/domain`）: エンティティ/純粋サービス（副作用なし）。状態遷移や乱数は services に集約。
- data（`src/lib/data`）: 定数/CSV/Repository。CSV 変更時は該当 Repository を同一 PR で同期更新。
- presentation（`src/lib/presentation`）: UI のみ。進行は domain/services を呼ぶ。UI にビジネスロジックを書かない。
- routes（`src/routes`）: ページ構成のみ。ビジネスロジック禁止。

### 依存関係ルール

- 依存方向は data → domain → presentation の一方向。逆流（presentation → data 直接参照）は禁止。
- 共有ユーティリティは層に応じた場所へ配置（domain 用/ UI 専用を混在させない）。

### 型・命名・ファイル配置

- `any` 禁止。公開型や関数シグネチャ変更は全利用箇所を同一 PR で更新。
- 1 ファイル 1 責務。重複は抽出して共通化。命名は意図が伝わるように（動詞+対象 等）。
- インポートは既存のエイリアス（`$lib/...`）方針に合わせる。

### UI / スタイル（Tailwind）

- `<style>` タグ禁止。Tailwind ユーティリティのみ使用。
- 重要度指定（`!important`/Tailwind の `!`）は原則禁止。
- 色は `@theme` の `--color-*` 変数を定義して `text-*` 等で参照（直書き禁止）。
- アイコンは `material-symbols` を使用。

### データ/CSV の扱い

- スキーマ変更（列追加/削除）は Repository を必ず同期更新し、破壊変更時は README/docs の更新も検討。
- csvはヘッダー行を必須とし、コメントの使用は禁止。

### 変更・PR チェックリスト（LLM 用）

2. 既存の型/関数/構造に整合。
3. CSV 変更時は Repository 同期・README/docs 更新を確認。更新。

### 禁止事項

- 依存方向の逆流、UI へのビジネスロジック混在、直接 DOM 操作の埋め込み。
- `any`、未使用コードの残置、色の直書き、任意 CSS の直付け、`<style>` タグ使用。

## 将来の改善候補

- JSDoc/TSDoc の形式でコメントを追加
- プレイヤーの初期値パターンを複数用意して、選択できるようにしてください。
- 階層でどのようなパターンで敵が出現するかをcsvで管理できるようにしてください。
- イベントでは、知力や魅力のチェックも行えるようにし、成功と失敗で分岐するようにしてください。イベントの管理はsrc/lib/data/constsでオブジェクトで管理して、チェックや分岐を定義しやすいようにインターフェースを整理してください。
- 鉱石の見た目のsvgを作成してください。同じカテゴリーでは色違いとしてください。
- 装身具を作成できるようにしてください。装身具は、鉱石を素材として作成でき、装備することでステータスが上昇します。同じカテゴリーのよりレベルの高い鉱石で強化を行います。装身具の種類はcsvで管理してください。
- ゲームオーバー時の仲間の加入は、加入できるか選択できるようにしてください。また、加入できる仲間の上限に抵触した場合は入れ替えを選択できるようにしてください。ステータスは元ステータスを参照し、装身具のみ引き継ぐようにしてください。
- お助け妖精ノードを追加し、鉱石を預かってもらえうようにしてください。預けた鉱石は、次のランに持ち越せるようにしてください。預けた鉱石の最大レベルの実績に応じて、預けられる鉱石の数が増えるようにしてください。
- デッキビルドできるように、アクションの数を増やす。シナジーを得やすいように、特定の数値を参照するアクションと、特定の数値を上昇させるアクションを増やす。
- 敵の状態のステータス参照がおかしく、ガードしても稀に軽減されないことがあるので修正してください。

## ライセンス / 著作権

外部アセットを追加する際はライセンス表記を README に追記。生成画像/音声は出典と生成プロンプトをメタデータで保持。
